#+TITLE: Analysis of multivariate binomial data: case control or ascertainment sampling 
#+AUTHOR: Klaus Holst & Thomas Scheike
#+INCLUDE: header.org
----- 


* Overview 

When looking at multivariate binomial data with the aim of learning about the 
dependence that is present, possibly after correcting for some covariates many
models are available. 

   -  Random-effects models logistic regression covered elsewhere (glmer in lme4).

in the mets package you can fit the 

   -  Pairwise odds ratio model
   -  Bivariate Probit model 
      - With random effects
      - Special functionality for polygenic random effects modelling 
        such as ACE, ADE ,AE and so forth.
   -  Additive gamma random effects model 
      - Special functionality for polygenic random effects modelling 
        such as ACE, ADE ,AE and so forth.

These last three models are all fitted in the mets package using composite 
likelihoods for pairs of data.  The models can be fitted specifically based 
on specifying which pairs one wants to use for the composite score. 

The models are described in futher details in the binomial-twin vignette. 


** Case-Control Sampling 

Sometimes, pairs are recruited after a case-proband is selected. This 
proband, can be either  a 

 - case: must be representative of cases

or  a 

 - control: must be representative of controls

First thinking about pairs, we estimate parameters using the conditional 
likelihood given sampling wich for a binary 2 x 2 table can be 
written as
\[
\frac{P(i,j)}{P(j)}
\]
the probailty of seeing \( (i,j) \) for the pair, given that the proband was
observed as \( (j) \).


We note that if the marginal is known, or possibly estimated from the full 
cohort. Then we can estimate dependence paramters using just the terms
\( P(i,j) \) for the pairs. We can thus ignore the special sampling for
models with marginal specification.  If the marginal can not be obtained 
from other sources we need to maximize the full-pairwise-likelihood in all
paramters, that is both dependence and marginal parameters. 

Similary, one can select a whole family based on having selected a proband, that is 
selected a representative member of  either cases or controls.  In this case we 
fit the models by using composited likelihoods, considering all
pairs that involves the probands.  This will give some lacking efficiency 
compared to looking at the full likelihood of the family given the proband. 


** Ascertainment Sampling 

Similarly, in the setting of pairs we can select all pairs where there is at 
least one event of interest.  

First thinking about pairs, we estimate parameters using the conditional 
likelihood given sampling wich for a binary 2 x 2 table can be 
written as
\[
\frac{P(i,j)}{1-P(0,0)}
\]
the probailty of seeing \( (i,j) \) for the pair, given that it is sampled. 

If the marginal can estimated from a full sample we can then estimate the
dependence paramter using the ascertainment likelihood.

Generally, when whole families are ascertained the computation of the
true truncation probability can be hard to the fact that families are
hard to define in the real world. Nevertheless, if a random sample of such
family is at hand. We suggest to in these families take out all pairs that 
satisfies the ascertainment criterion. With a family, with given size \( n \)
we have binary observations \( (Y_1,...,Y_n) \). The family is sampled or  a
random sample of families such that
\[ 
\sum_{i=1}^n Y_i \geq 1.
\]
We let the conditional distribution given sampling, be denoted as 
\[ 
P^O(\cdot) = P(\cdot | \sum_{i=1}^n Y_i \geq 1) 
\]

Now, we note that all pairs within these family that satisfies that 
\( Y_i+Y_j \geq 1 \), will have distribution
\begin{align*}
P^O(Y_i=o_1, Y_j=o_2 | Y_i+Y_j \geq 1)  & = \frac{P^O(o_1,o_2)}{P^O( Y_i+Y_j \geq 1)} \\
                                        & = \frac{P(Y_i=o_1,Y_j=o_2, \sum_{i=1}^n Y_i \geq 1)}{ P( Y_i+Y_j \geq 1, \sum_{i=1}^n Y_i \geq 1)} \\
                                        & = \frac{P(Y_i=o_1,Y_j=o_2) }{ P( Y_i+Y_j \geq 1)} = \frac{P(o_1,o_2)}{1 - P(0,0)} 
\end{align*}
since we only consider the probabilities where \( o_1+o_2 \geq 1 \). 
Also here we could condition on covariates. 

So considering these pairs, or a random sample of them should yield valid 
inference. When standard errors are computed we need to rely on GEE type 
arguments. An advantage of this is that the ascertainment probability is much 
easier to get for the pairs. Again using the pairwise structure will   lead
to loss of efficiency compared to using the full likelihood of the ascertained
families. 


* The twin-stutter data

We consider the twin-stutter where for pairs of twins that are 
either dizygotic or monozygotic we have recorded whether the twins
are stuttering \cite{twinstut-ref}

We here consider MZ and same sex DZ twins. 

Looking at the data 

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
library(mets)
data(twinstut)
twinstut$binstut <- 1*(twinstut$stutter=="yes")
twinstut <- subset(twinstut,zyg%in%c("mz","dz"))
head(twinstut)
#+END_SRC

#+RESULTS:
#+begin_example
Loading required package: timereg
Loading required package: survival
Loading required package: lava
lava version 1.4.7.1
mets version 1.2.1

Attaching package: ‘mets’

The following object is masked _by_ ‘.GlobalEnv’:

    object.defined
   tvparnr zyg stutter    sex age nr binstut
1  2001005  mz      no female  71  1       0
2  2001005  mz      no female  71  2       0
3  2001006  dz      no female  71  1       0
8  2001012  mz      no female  71  1       0
9  2001012  mz      no female  71  2       0
11 2001015  dz      no   male  71  1       0
#+end_example


- First,  we select an ascertaiment sample of the data, thus selecting
  a random sample of all ascertained pairs. 

- Secondly, we select a case-control sample of this data to illustrate the use
  of the methods.


* Ascertaiment Sampling 

Selecting the ascertained pairs 

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
library(mets)
data(twinstut)
twinstut$binstut <- 1*(twinstut$stutter=="yes")
twinstut <- subset(twinstut,zyg%in%c("mz","dz"))
dnumeric(twinstut) <- ~.
dfactor(twinstut,labels=c("DZ","MZ")) <- binzyg~zyg.n
ddrop(twinstut) <- ~"*.n"

twinstut  <-   dby(twinstut,binstut~tvparnr,stuttot=sum,nn=seq_along,n=length)
twina     <-   subset(twinstut,n==2 & stuttot>=1)
#+END_SRC  

#+RESULTS:

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
twinda <- fast.reshape(twina,id="tvparnr")
twind <- fast.reshape(twinstut,id="tvparnr")
dtable(twind,"binst*"~I(stuttot>=1))
dtable(twinda,~"binst*")
#+END_SRC  

#+RESULTS:
: Error in unique(c("AsIs", oldClass(x))) : object 'stuttot' not found
: 
:          binstut2   0   1
: binstut1                 
: 0                   0 289
: 1                 281 111


Now doing the analyses 

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
ba1 <- biprobit(binstut~sex,~-1+binzyg,data=twina,id="tvparnr",pair.ascertained=TRUE)
summary(ba1)
#+END_SRC  

#+RESULTS:
#+begin_example

              Estimate    Std.Err          Z p-value
(Intercept)   0.101193   0.031912   3.170993  0.0015
sexmale       0.049255   0.042886   1.148495  0.2508
r:binzygDZ   -3.952376   0.282620 -13.984759  0.0000
r:binzygMZ   -0.840831   0.169676  -4.955514  0.0000

logLik: -690.9136  mean(score^2): 5.008e-11 
    n pairs 
 1362   681 

Contrast:
	Dependence    [binzygDZ] 
	Mean          [(Intercept)] 

                        Estimate 2.5%     97.5%   
Rel.Recur.Risk           0.27611  0.13140  0.42081
OR                       0.00000      NaN      NaN
Tetrachoric correlation -0.99926 -0.99976 -0.99777
                                                  
Concordance              0.08060  0.04294  0.14627
Casewise Concordance     0.14918  0.08234  0.25520
Marginal                 0.54030  0.51540  0.56501
#+end_example

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
b1 <- biprobit(binstut~sex,~-1+binzyg,data=twinstut,id="tvparnr")
summary(b1)
#+END_SRC  

#+RESULTS:
#+begin_example

              Estimate    Std.Err          Z p-value
(Intercept)  -1.794821   0.023289 -77.066826  0.0000
sexmale       0.401430   0.030179  13.301756  0.0000
r:binzygDZ    0.132458   0.062516   2.118802  0.0341
r:binzygMZ    1.096915   0.073574  14.909085  0.0000

logLik: -4400.536  mean(score^2): 1.022e-06 
    n pairs 
21288  7313 

Contrast:
	Dependence    [binzygDZ] 
	Mean          [(Intercept)] 

                        Estimate 2.5%    97.5%  
Rel.Recur.Risk          1.77662  0.92746 2.62577
OR                      1.88752  1.09432 3.25566
Tetrachoric correlation 0.13169  0.00993 0.24960
                                                
Concordance             0.00235  0.00140 0.00393
Casewise Concordance    0.06456  0.03937 0.10413
Marginal                0.03634  0.03287 0.04016
#+end_example


#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
b1 <- bptwin(binstut~sex,data=twinstut,id="tvparnr",zyg="zyg",DZ="dz",type="un")
summary(b1)
#+END_SRC  

#+RESULTS:
#+begin_example

                Estimate    Std.Err          Z p-value
(Intercept)    -1.794823   0.023289 -77.066728  0.0000
sexmale         0.401432   0.030179  13.301813  0.0000
atanh(rho) MZ   1.096916   0.073574  14.909087  0.0000
atanh(rho) DZ   0.132458   0.062516   2.118800  0.0341

 Total MZ/DZ Complete pairs MZ/DZ
 8777/12511  3255/4058           

                           Estimate 2.5%    97.5%  
Tetrachoric correlation MZ 0.79939  0.74101 0.84577
Tetrachoric correlation DZ 0.13169  0.00993 0.24960

MZ:
                     Estimate 2.5%     97.5%   
Concordance           0.01698  0.01411  0.02042
Casewise Concordance  0.46730  0.40383  0.53185
Marginal              0.03634  0.03287  0.04016
Rel.Recur.Risk       12.85882 10.87510 14.84253
log(OR)               3.75632  3.37975  4.13289
DZ:
                     Estimate 2.5%    97.5%  
Concordance          0.00235  0.00140 0.00393
Casewise Concordance 0.06456  0.03937 0.10413
Marginal             0.03634  0.03287 0.04016
Rel.Recur.Risk       1.77662  0.92746 2.62577
log(OR)              0.63527  0.09013 1.18040

                         Estimate 2.5% 97.5%
Broad-sense heritability   1      NaN  NaN
#+end_example

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
b1 <- bptwin(binstut~sex,data=twinstut,id="tvparnr",zyg="zyg",DZ="dz",type="ae")
summary(b1)
#+END_SRC  

#+RESULTS:
#+begin_example

             Estimate   Std.Err         Z p-value
(Intercept)  -3.70371   0.24449 -15.14855       0
sexmale       0.83310   0.08255  10.09201       0
log(var(A))   1.18278   0.17179   6.88512       0

 Total MZ/DZ Complete pairs MZ/DZ
 8777/12511  3255/4058           

                   Estimate 2.5%    97.5%  
A                  0.76545  0.70500 0.82590
E                  0.23455  0.17410 0.29500
MZ Tetrachoric Cor 0.76545  0.69793 0.81948
DZ Tetrachoric Cor 0.38272  0.35210 0.41253

MZ:
                     Estimate 2.5%     97.5%   
Concordance           0.01560  0.01273  0.01912
Casewise Concordance  0.42830  0.36248  0.49677
Marginal              0.03643  0.03294  0.04027
Rel.Recur.Risk       11.75741  9.77237 13.74246
log(OR)               3.52382  3.13466  3.91298
DZ:
                     Estimate 2.5%    97.5%  
Concordance          0.00558  0.00465 0.00670
Casewise Concordance 0.15327  0.13749 0.17050
Marginal             0.03643  0.03294 0.04027
Rel.Recur.Risk       4.20744  3.78588 4.62900
log(OR)              1.69996  1.57262 1.82730

                         Estimate 2.5%    97.5%  
Broad-sense heritability 0.76545  0.70500 0.82590
#+end_example



#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
margbin <- glm(binstut~factor(sex)+age,data=twinstut,family=binomial())
summary(margbin)
#+END_SRC  

#+RESULTS:
#+begin_example

Call:
glm(formula = binstut ~ factor(sex) + age, family = binomial(), 
    data = twinstut)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.4419  -0.4078  -0.2842  -0.2672   2.6395  

Coefficients:
                 Estimate Std. Error z value Pr(>|z|)    
(Intercept)     -3.027625   0.104012 -29.108  < 2e-16 ***
factor(sex)male  0.869826   0.062197  13.985  < 2e-16 ***
age             -0.005983   0.002172  -2.754  0.00588 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 9328.6  on 21287  degrees of freedom
Residual deviance: 9117.0  on 21285  degrees of freedom
AIC: 9123

Number of Fisher Scoring iterations: 6
#+end_example


#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
theta.des <- model.matrix( ~-1+factor(zyg),data=twinstut)
bin <- binomial.twostage(margbin,data=twinstut,var.link=1,
                          clusters=twinstut$tvparnr,theta.des=theta.des)
summary(bin)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Odds-Ratio (Plackett) model 
With log-link 
$estimates
                  theta        se
factor(zyg)dz 0.5221651 0.2401355
factor(zyg)mz 3.4853933 0.1866076

$or
              Estimate Std.Err   2.5% 97.5%  P-value
factor(zyg)dz     1.69   0.405  0.892  2.48 3.12e-05
factor(zyg)mz    32.64   6.090 20.699 44.57 8.38e-08

$type
[1] "plackett"

attr(,"class")
[1] "summary.mets.twostage"
#+end_example



#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
theta.des <- model.matrix( ~-1+factor(zyg),data=twina)
bina <- binomial.twostage(margbin,data=twina,var.link=1,
                          clusters=twina$tvparnr,theta.des=theta.des,
			  pair.ascertained=1)
summary(bina)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Odds-Ratio (Plackett) model 
With log-link 
$estimates
                  theta        se
factor(zyg)dz 0.4886837 0.2473226
factor(zyg)mz 3.4518876 0.1986753

$or
              Estimate Std.Err  2.5% 97.5%  P-value
factor(zyg)dz     1.63   0.403  0.84  2.42 5.27e-05
factor(zyg)mz    31.56   6.270 19.27 43.85 4.82e-07

$type
[1] "plackett"

attr(,"class")
[1] "summary.mets.twostage"
#+end_example

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
theta.des <- model.matrix( ~-1+factor(zyg),data=twina)
bina <- binomial.twostage(margbin,data=twina,var.link=1,
                          clusters=twina$tvparnr,theta.des=theta.des,
			  pair.ascertained=1)
summary(bina)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Odds-Ratio (Plackett) model 
With log-link 
$estimates
                  theta        se
factor(zyg)dz 0.4886837 0.2473226
factor(zyg)mz 3.4518876 0.1986753

$or
              Estimate Std.Err  2.5% 97.5%  P-value
factor(zyg)dz     1.63   0.403  0.84  2.42 5.27e-05
factor(zyg)mz    31.56   6.270 19.27 43.85 4.82e-07

$type
[1] "plackett"

attr(,"class")
[1] "summary.mets.twostage"
#+end_example



#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
out <- twin.polygen.design(twinstut,id="tvparnr",zygname="zyg",zyg="dz",type="ace")
margbin <- glm(binstut~sex,data=twinstut,family=binomial())
bintwin1 <- binomial.twostage(margbin,data=twinstut,
     clusters=twinstut$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=out$des.rv,theta.des=out$pardes)
summary(bintwin1)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                 theta        se
dependence1  1.5261839 0.2475041
dependence2 -0.5447955 0.1942159

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err   2.5%  97.5%  P-value
dependence1    1.555   0.187  1.189  1.922 9.11e-17
dependence2   -0.555   0.187 -0.922 -0.189 2.99e-03

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.981   0.102 0.781  1.18 8.29e-22

attr(,"class")
[1] "summary.mets.twostage"
#+end_example

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
out <- twin.polygen.design(twinstut,id="tvparnr",zygname="zyg",zyg="dz",type="ae")
bintwin <- binomial.twostage(margbin,data=twinstut,
     clusters=twinstut$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=out$des.rv,theta.des=out$pardes)
summary(bintwin)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                theta         se
dependence1 0.9094847 0.09536268

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.909  0.0954 0.723   1.1 1.47e-21

attr(,"class")
[1] "summary.mets.twostage"
#+end_example


#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
outa <- twin.polygen.design(twina,id="tvparnr",zygname="zyg",zyg="dz",type="ace")
marga <- glm(binstut~sex,data=twina,family=binomial())
abintwin1 <- binomial.twostage(margbin,data=twina,
     clusters=twina$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=outa$des.rv,theta.des=outa$pardes,pair.ascertained=1)
summary(abintwin1)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                 theta        se
dependence1  1.5325708 0.2588839
dependence2 -0.5618869 0.1990532

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err   2.5%  97.5%  P-value
dependence1    1.579   0.191  1.205  1.953 1.23e-16
dependence2   -0.579   0.191 -0.953 -0.205 2.40e-03

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.971   0.107 0.761  1.18 1.34e-19

attr(,"class")
[1] "summary.mets.twostage"
#+end_example

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
outa <- twin.polygen.design(twina,id="tvparnr",zygname="zyg",zyg="dz",type="ae")
marga <- glm(binstut~sex,data=twina,family=binomial())
abintwin1 <- binomial.twostage(margbin,data=twina,
     clusters=twina$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=outa$des.rv,theta.des=outa$pardes,pair.ascertained=1)
summary(abintwin1)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                theta         se
dependence1 0.8920274 0.09732786

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.892  0.0973 0.701  1.08 4.95e-20

attr(,"class")
[1] "summary.mets.twostage"
#+end_example


#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
marga <- glm(binstut~sex,data=twina,family=binomial())
aabintwin1 <- binomial.twostage(marga,data=twina,
     clusters=twina$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=outa$des.rv,theta.des=outa$pardes,pair.ascertained=1,twostage=0)
summary(aabintwin1)
coef(marga)
coef(margbin)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
[[1]]
[[1]]$estimates
               theta        se
dependence1 1.014398 0.1045593

[[1]]$type
[1] "clayton.oakes"

[[1]]$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

[[1]]$vare
NULL

[[1]]$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1     1.01   0.105 0.809  1.22 2.97e-22


$marginal
             Coef.      SE Robust SE     z P-val lower2.5% upper97.5%
dependence2 -4.350 0.08560   0.08560 -50.8     0    -4.520     -4.180
dependence3  0.551 0.00606   0.00606  90.8     0     0.539      0.563

attr(,"class")
[1] "summary.mets.twostage"
(Intercept)     sexmale 
  0.2789484   0.0824214
(Intercept)     sexmale 
 -3.2819072   0.8617053
#+end_example


* Case Control Sampling 

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 

twinstut  <-   dby(twinstut,binstut~tvparnr,stuttot=sum,nn=seq_along,n=length)
twinstut <-    subset(twinstut,n==2)
twinstut  <-   dtransform(twinstut,nnrow=1:nrow(twinstut))
twinstut  <-   dby(twinstut,binstut~tvparnr,nnn=seq_along)
twinstut  <-   dby2(twinstut,nnrow~tvparnr,pairnr=rev)

cases <- which(twinstut$binstut==1)
controls <- sample(which(twinstut$binstut==0),1217)
rowsca <- with(twinstut,nnrow[cases])
rowsco <- with(twinstut,nnrow[controls])
rpairs <- c(rowsca,rowsco)
cc.pairs <- cbind( with(twinstut,pairnr.nnrow[rpairs]),rpairs)

ids <- sort(unique(c(cc.pairs)))
###
pairsids <- c(cc.pairs)
pair.new <- matrix(fast.approx(ids,pairsids),ncol=2)
head(pair.new)

dataid <- dsort(twinstut[ids,],"tvparnr")
dataid=dtransform(dataid,kinship=0.5)
dataid=dtransform(dataid,kinship=1,binzyg=="MZ")
kinship <- dataid$kinship[pair.new[,2]]

out <- make.pairwise.design(pair.new,kinship,type="ae") 
names(out)
out$random.des[,,1]
out$theta.des[,,1]
#+END_SRC  

#+RESULTS:
#+begin_example
     [,1] [,2]
[1,]   10    9
[2,]   28   27
[3,]   32   31
[4,]   54   53
[5,]   58   57
[6,]   64   63
[1] "random.design" "theta.des"     "ant.rvs"
     [,1] [,2] [,3]
[1,]    1    1    0
[2,]    1    0    1
[1] 0.5 0.5 0.5
#+end_example

Now doing the analyses 

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
cc  <- binomial.twostage(margbin,data=dataid,
			    clusters=dataid$tvparnr,
	     pairs=pair.new,
	     random.design=out$random.design,
             theta.des=out$theta.des,
	     pairs.rvs=out$ant.rvs,
             case.control=0,twostage=1)
summary(tsdid3)
#+END_SRC  

#+RESULTS:
: Error in summary(tsdid3) : object 'tsdid3' not found


#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
cc3 <- binomial.twostage(margbin,data=dataid,
			    clusters=dataid$tvparnr,
	     pairs=pair.new,
	     random.design=out$random.design,
             theta.des=out$theta.des,
	     pairs.rvs=out$ant.rvs,
             case.control=1,twostage=1)
summary(cc3)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                theta         se
dependence1 0.8845341 0.09758998

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.885  0.0976 0.693  1.08 1.26e-19

attr(,"class")
[1] "summary.mets.twostage"
#+end_example


#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
marga <- glm(binstut~sex,data=dataid,family=binomial())
cc3 <- binomial.twostage(marga,data=dataid,
             clusters=dataid$tvparnr,
	     pairs=pair.new,
	     random.design=out$random.design,
             theta.des=out$theta.des,
	     pairs.rvs=out$ant.rvs,
             case.control=1,twostage=0)
summary(cc3)
#+END_SRC  

#+RESULTS:
#+begin_example
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
[[1]]
[[1]]$estimates
                theta         se
dependence1 0.9128708 0.09740372

[[1]]$type
[1] "clayton.oakes"

[[1]]$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

[[1]]$vare
NULL

[[1]]$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.913  0.0974 0.722   1.1 7.11e-21


$marginal
             Coef.      SE Robust SE      z P-val lower2.5% upper97.5%
dependence2 -3.440 0.00422   0.00422 -816.0     0    -3.450     -3.430
dependence3  0.634 0.01990   0.01990   31.8     0     0.595      0.673

attr(,"class")
[1] "summary.mets.twostage"
#+end_example



* COMMENT 

#+BEGIN_SRC R :results output :exports both :session *R* :cache no 
library(mets)
data(twinstut)
twinstut$binstut <- 1*(twinstut$stutter=="yes")
twinsall <- twinstut
twinstut <- subset(twinstut,zyg%in%c("mz","dz"))
head(twinstut)
twinstut <- subset(twinstut,zyg%in%c("mz","dz"))
dnumeric(twinstut) <- ~.
dfactor(twinstut,labels=c("DZ","MZ")) <- binzyg~zyg.n
ddrop(twinstut) <- ~"*.n"


twinstut  <-   dby(twinstut,binstut~tvparnr,stuttot=sum,nn=seq_along,n=length)
twina     <-   subset(twinstut,n==2 & stuttot>=1)

ba1 <- biprobit(binstut~sex,~-1+binzyg,data=twina,id="tvparnr",pair.ascertained=TRUE)
summary(ba1)

b1 <- biprobit(binstut~sex,~-1+binzyg,data=twinstut,id="tvparnr")
summary(b1)


b1 <- bptwin(binstut~sex,data=twinstut,id="tvparnr",zyg="zyg",DZ="dz",type="un")
summary(b1)

b1 <- bptwin(binstut~sex,data=twinstut,id="tvparnr",zyg="zyg",DZ="dz",type="ae")
summary(b1)



###b1 <- bptwin(binstut~sex,data=twina,id="tvparnr",zyg="zyg",DZ="dz",type="un")
###summary(b1)
###
###b1 <- bptwin(binstut~sex,data=twina,id="tvparnr",zyg="zyg",DZ="dz",type="ae")
###summary(b1)

margbin <- glm(binstut~factor(sex)+age,data=twinstut,family=binomial())
summary(margbin)


theta.des <- model.matrix( ~-1+factor(zyg),data=twinstut)
bin <- binomial.twostage(margbin,data=twinstut,var.link=1,
                          clusters=twinstut$tvparnr,theta.des=theta.des)
summary(bin)



theta.des <- model.matrix( ~-1+factor(zyg),data=twina)
bina <- binomial.twostage(margbin,data=twina,var.link=1,
                          clusters=twina$tvparnr,theta.des=theta.des,
			  pair.ascertained=1)
summary(bina)

theta.des <- model.matrix( ~-1+factor(zyg),data=twina)
bina <- binomial.twostage(margbin,data=twina,var.link=1,
                          clusters=twina$tvparnr,theta.des=theta.des,
			  pair.ascertained=1)
summary(bina)



out <- twin.polygen.design(twinstut,id="tvparnr",zygname="zyg",zyg="dz",type="ace")
margbin <- glm(binstut~sex,data=twinstut,family=binomial())
bintwin1 <- binomial.twostage(margbin,data=twinstut,
     clusters=twinstut$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=out$des.rv,theta.des=out$pardes)
summary(bintwin1)


out <- twin.polygen.design(twinstut,id="tvparnr",zygname="zyg",zyg="dz",type="ae")
bintwin <- binomial.twostage(margbin,data=twinstut,
     clusters=twinstut$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=out$des.rv,theta.des=out$pardes)
summary(bintwin)



outa <- twin.polygen.design(twina,id="tvparnr",zygname="zyg",zyg="dz",type="ace")
marga <- glm(binstut~sex,data=twina,family=binomial())
abintwin1 <- binomial.twostage(margbin,data=twina,
     clusters=twina$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=outa$des.rv,theta.des=outa$pardes,pair.ascertained=1)
summary(abintwin1)

outa <- twin.polygen.design(twina,id="tvparnr",zygname="zyg",zyg="dz",type="ae")
marga <- glm(binstut~sex,data=twina,family=binomial())
abintwin1 <- binomial.twostage(margbin,data=twina,
     clusters=twina$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=outa$des.rv,theta.des=outa$pardes,pair.ascertained=1)
summary(abintwin1)


marga <- glm(binstut~sex,data=twina,family=binomial())
aabintwin1 <- binomial.twostage(marga,data=twina,
     clusters=twina$tvparnr,detail=0,theta=c(0.1)/1,var.link=0,
     random.design=outa$des.rv,theta.des=outa$pardes,pair.ascertained=1,twostage=0)
summary(aabintwin1)
coef(marga)
coef(margbin)


##################################################
### case control sampling 
##################################################

twinstut  <-   dby(twinstut,binstut~tvparnr,stuttot=sum,nn=seq_along,n=length)
twinstut <- subset(twinstut,n==2)
twinstut  <-   dtransform(twinstut,nnrow=1:nrow(twinstut))
twinstut  <-   dby(twinstut,binstut~tvparnr,nnn=seq_along)
twinstut  <-   dby2(twinstut,nnrow~tvparnr,pairnr=rev)


cases <- which(twinstut$binstut==1)
controls <- sample(which(twinstut$binstut==0),1217)
rowsca <- with(twinstut,nnrow[cases])
rowsco <- with(twinstut,nnrow[controls])
rpairs <- c(rowsca,rowsco)
cc.pairs <- cbind( with(twinstut,pairnr.nnrow[rpairs]),rpairs)

ids <- sort(unique(c(cc.pairs)))
###
pairsids <- c(cc.pairs)
pair.new <- matrix(fast.approx(ids,pairsids),ncol=2)
head(pair.new)

dataid <- dsort(twinstut[ids,],"tvparnr")
dataid=dtransform(dataid,kinship=0.5)
dataid=dtransform(dataid,kinship=1,binzyg=="MZ")
kinship <- dataid$kinship[pair.new[,2]]

out <- make.pairwise.design(pair.new,kinship,type="ae") 
names(out)
out$random.des[,,1]
out$theta.des[,,1]

###source("mets/R/twostage.R")
###source("mets/R/binomial.twostage.R")

tsdid3 <- binomial.twostage(margbin,data=dataid,
			    clusters=dataid$tvparnr,
	     pairs=pair.new,
	     random.design=out$random.design,
             theta.des=out$theta.des,
	     pairs.rvs=out$ant.rvs,
             case.control=0,twostage=1)
summary(tsdid3)


cc3 <- binomial.twostage(margbin,data=dataid,
			    clusters=dataid$tvparnr,
	     pairs=pair.new,
	     random.design=out$random.design,
             theta.des=out$theta.des,
	     pairs.rvs=out$ant.rvs,
             case.control=1,twostage=1)
summary(cc3)


marga <- glm(binstut~sex,data=dataid,family=binomial())
cc3 <- binomial.twostage(marga,data=dataid,
             clusters=dataid$tvparnr,
	     pairs=pair.new,
	     random.design=out$random.design,
             theta.des=out$theta.des,
	     pairs.rvs=out$ant.rvs,
             case.control=1,twostage=0)
summary(cc3)

#+END_SRC  

#+RESULTS:
#+begin_example
   tvparnr zyg stutter    sex age nr binstut
1  2001005  mz      no female  71  1       0
2  2001005  mz      no female  71  2       0
3  2001006  dz      no female  71  1       0
8  2001012  mz      no female  71  1       0
9  2001012  mz      no female  71  2       0
11 2001015  dz      no   male  71  1       0

              Estimate    Std.Err          Z p-value
(Intercept)   0.101193   0.031912   3.170993  0.0015
sexmale       0.049255   0.042886   1.148495  0.2508
r:binzygDZ   -3.952376   0.282620 -13.984759  0.0000
r:binzygMZ   -0.840831   0.169676  -4.955514  0.0000

logLik: -690.9136  mean(score^2): 5.008e-11 
    n pairs 
 1362   681 

Contrast:
	Dependence    [binzygDZ] 
	Mean          [(Intercept)] 

                        Estimate 2.5%     97.5%   
Rel.Recur.Risk           0.27611  0.13140  0.42081
OR                       0.00000      NaN      NaN
Tetrachoric correlation -0.99926 -0.99976 -0.99777
                                                  
Concordance              0.08060  0.04294  0.14627
Casewise Concordance     0.14918  0.08234  0.25520
Marginal                 0.54030  0.51540  0.56501

              Estimate    Std.Err          Z p-value
(Intercept)  -1.794821   0.023289 -77.066826  0.0000
sexmale       0.401430   0.030179  13.301756  0.0000
r:binzygDZ    0.132458   0.062516   2.118802  0.0341
r:binzygMZ    1.096915   0.073574  14.909085  0.0000

logLik: -4400.536  mean(score^2): 1.022e-06 
    n pairs 
21288  7313 

Contrast:
	Dependence    [binzygDZ] 
	Mean          [(Intercept)] 

                        Estimate 2.5%    97.5%  
Rel.Recur.Risk          1.77662  0.92746 2.62577
OR                      1.88752  1.09432 3.25566
Tetrachoric correlation 0.13169  0.00993 0.24960
                                                
Concordance             0.00235  0.00140 0.00393
Casewise Concordance    0.06456  0.03937 0.10413
Marginal                0.03634  0.03287 0.04016

                Estimate    Std.Err          Z p-value
(Intercept)    -1.794823   0.023289 -77.066728  0.0000
sexmale         0.401432   0.030179  13.301813  0.0000
atanh(rho) MZ   1.096916   0.073574  14.909087  0.0000
atanh(rho) DZ   0.132458   0.062516   2.118800  0.0341

 Total MZ/DZ Complete pairs MZ/DZ
 8777/12511  3255/4058           

                           Estimate 2.5%    97.5%  
Tetrachoric correlation MZ 0.79939  0.74101 0.84577
Tetrachoric correlation DZ 0.13169  0.00993 0.24960

MZ:
                     Estimate 2.5%     97.5%   
Concordance           0.01698  0.01411  0.02042
Casewise Concordance  0.46730  0.40383  0.53185
Marginal              0.03634  0.03287  0.04016
Rel.Recur.Risk       12.85882 10.87510 14.84253
log(OR)               3.75632  3.37975  4.13289
DZ:
                     Estimate 2.5%    97.5%  
Concordance          0.00235  0.00140 0.00393
Casewise Concordance 0.06456  0.03937 0.10413
Marginal             0.03634  0.03287 0.04016
Rel.Recur.Risk       1.77662  0.92746 2.62577
log(OR)              0.63527  0.09013 1.18040

                         Estimate 2.5% 97.5%
Broad-sense heritability   1      NaN  NaN

             Estimate   Std.Err         Z p-value
(Intercept)  -3.70371   0.24449 -15.14855       0
sexmale       0.83310   0.08255  10.09201       0
log(var(A))   1.18278   0.17179   6.88512       0

 Total MZ/DZ Complete pairs MZ/DZ
 8777/12511  3255/4058           

                   Estimate 2.5%    97.5%  
A                  0.76545  0.70500 0.82590
E                  0.23455  0.17410 0.29500
MZ Tetrachoric Cor 0.76545  0.69793 0.81948
DZ Tetrachoric Cor 0.38272  0.35210 0.41253

MZ:
                     Estimate 2.5%     97.5%   
Concordance           0.01560  0.01273  0.01912
Casewise Concordance  0.42830  0.36248  0.49677
Marginal              0.03643  0.03294  0.04027
Rel.Recur.Risk       11.75741  9.77237 13.74246
log(OR)               3.52382  3.13466  3.91298
DZ:
                     Estimate 2.5%    97.5%  
Concordance          0.00558  0.00465 0.00670
Casewise Concordance 0.15327  0.13749 0.17050
Marginal             0.03643  0.03294 0.04027
Rel.Recur.Risk       4.20744  3.78588 4.62900
log(OR)              1.69996  1.57262 1.82730

                         Estimate 2.5%    97.5%  
Broad-sense heritability 0.76545  0.70500 0.82590

Call:
glm(formula = binstut ~ factor(sex) + age, family = binomial(), 
    data = twinstut)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.4419  -0.4078  -0.2842  -0.2672   2.6395  

Coefficients:
                 Estimate Std. Error z value Pr(>|z|)    
(Intercept)     -3.027625   0.104012 -29.108  < 2e-16 ***
factor(sex)male  0.869826   0.062197  13.985  < 2e-16 ***
age             -0.005983   0.002172  -2.754  0.00588 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 9328.6  on 21287  degrees of freedom
Residual deviance: 9117.0  on 21285  degrees of freedom
AIC: 9123

Number of Fisher Scoring iterations: 6
Dependence parameter for Odds-Ratio (Plackett) model 
With log-link 
$estimates
                  theta        se
factor(zyg)dz 0.5221651 0.2401355
factor(zyg)mz 3.4853933 0.1866076

$or
              Estimate Std.Err   2.5% 97.5%  P-value
factor(zyg)dz     1.69   0.405  0.892  2.48 3.12e-05
factor(zyg)mz    32.64   6.090 20.699 44.57 8.38e-08

$type
[1] "plackett"

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Odds-Ratio (Plackett) model 
With log-link 
$estimates
                  theta        se
factor(zyg)dz 0.4886837 0.2473226
factor(zyg)mz 3.4518876 0.1986753

$or
              Estimate Std.Err  2.5% 97.5%  P-value
factor(zyg)dz     1.63   0.403  0.84  2.42 5.27e-05
factor(zyg)mz    31.56   6.270 19.27 43.85 4.82e-07

$type
[1] "plackett"

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Odds-Ratio (Plackett) model 
With log-link 
$estimates
                  theta        se
factor(zyg)dz 0.4886837 0.2473226
factor(zyg)mz 3.4518876 0.1986753

$or
              Estimate Std.Err  2.5% 97.5%  P-value
factor(zyg)dz     1.63   0.403  0.84  2.42 5.27e-05
factor(zyg)mz    31.56   6.270 19.27 43.85 4.82e-07

$type
[1] "plackett"

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                 theta        se
dependence1  1.5261839 0.2475041
dependence2 -0.5447955 0.1942159

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err   2.5%  97.5%  P-value
dependence1    1.555   0.187  1.189  1.922 9.11e-17
dependence2   -0.555   0.187 -0.922 -0.189 2.99e-03

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.981   0.102 0.781  1.18 8.29e-22

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                theta         se
dependence1 0.9094847 0.09536268

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.909  0.0954 0.723   1.1 1.47e-21

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                 theta        se
dependence1  1.5325708 0.2588839
dependence2 -0.5618869 0.1990532

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err   2.5%  97.5%  P-value
dependence1    1.579   0.191  1.205  1.953 1.23e-16
dependence2   -0.579   0.191 -0.953 -0.205 2.40e-03

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.971   0.107 0.761  1.18 1.34e-19

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                theta         se
dependence1 0.8920274 0.09732786

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.892  0.0973 0.701  1.08 4.95e-20

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
[[1]]
[[1]]$estimates
               theta        se
dependence1 1.014398 0.1045593

[[1]]$type
[1] "clayton.oakes"

[[1]]$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

[[1]]$vare
NULL

[[1]]$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1     1.01   0.105 0.809  1.22 2.97e-22


$marginal
             Coef.      SE Robust SE     z P-val lower2.5% upper97.5%
dependence2 -4.350 0.08560   0.08560 -50.8     0    -4.520     -4.180
dependence3  0.551 0.00606   0.00606  90.8     0     0.539      0.563

attr(,"class")
[1] "summary.mets.twostage"
(Intercept)     sexmale 
  0.2789484   0.0824214
(Intercept)     sexmale 
 -3.2819072   0.8617053
     [,1] [,2]
[1,]   12   11
[2,]   18   17
[3,]   20   19
[4,]   40   39
[5,]   44   43
[6,]   54   53
[1] "random.design" "theta.des"     "ant.rvs"
     [,1] [,2] [,3]
[1,]    1    1    0
[2,]    1    0    1
[1] 0.5 0.5 0.5
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                theta       se
dependence1 0.8782406 0.096999

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.878   0.097 0.688  1.07 1.38e-19

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
$estimates
                theta       se
dependence1 0.8782406 0.096999

$type
[1] "clayton.oakes"

$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

$vare
NULL

$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.878   0.097 0.688  1.07 1.38e-19

attr(,"class")
[1] "summary.mets.twostage"
Dependence parameter for Clayton-Oakes model
Variance of Gamma distributed random effects 
[[1]]
[[1]]$estimates
               theta         se
dependence1 0.908619 0.09671327

[[1]]$type
[1] "clayton.oakes"

[[1]]$h
            Estimate Std.Err 2.5% 97.5% P-value
dependence1        1       0    1     1       0

[[1]]$vare
NULL

[[1]]$vartot
   Estimate Std.Err  2.5% 97.5%  P-value
p1    0.909  0.0967 0.719   1.1 5.72e-21


$marginal
             Coef.      SE Robust SE       z P-val lower2.5% upper97.5%
dependence2 -3.340 0.00117   0.00117 -2850.0     0    -3.340     -3.340
dependence3  0.485 0.01320   0.01320    36.7     0     0.459      0.511

attr(,"class")
[1] "summary.mets.twostage"
#+end_example

